name: Flutter CI/CD with Shorebird

on:
  push:
    branches:
      - staging

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.3'
          channel: 'stable'
      
      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # 4Ô∏è‚É£ Install Shorebird CLI
      - name: Install Shorebird CLI
        run: |
          echo "üîß Installing Shorebird CLI..."
          mkdir -p $HOME/.shorebird/bin

          # Use jq to properly parse JSON response
          LATEST_URL=$(curl -s https://api.github.com/repos/shorebirdtech/shorebird/releases/latest \
            | grep -o '"browser_download_url":[^,]*' \
            | grep "linux-x64.zip" \
            | cut -d '"' -f 4)

          # Alternative method if above fails
          if [ -z "$LATEST_URL" ]; then
            echo "Trying alternative download method..."
            LATEST_URL="https://github.com/shorebirdtech/shorebird/releases/latest/download/shorebird-linux-x64.zip"
          fi

          echo "üì¶ Downloading from: $LATEST_URL"

          if [ -z "$LATEST_URL" ]; then
            echo "‚ùå Could not find Shorebird release URL."
            echo "Available assets from latest release:"
            curl -s https://api.github.com/repos/shorebirdtech/shorebird/releases/latest | grep "browser_download_url"
            exit 1
          fi

          # Download and install
          curl -L -f "$LATEST_URL" -o shorebird.zip || {
            echo "‚ùå Failed to download Shorebird"
            exit 1
          }
          
          unzip -q shorebird.zip -d $HOME/.shorebird/bin
          chmod +x $HOME/.shorebird/bin/shorebird

          echo "$HOME/.shorebird/bin" >> $GITHUB_PATH
          echo "‚úÖ Shorebird installed successfully!"
          $HOME/.shorebird/bin/shorebird --version

      # 5Ô∏è‚É£ Login to Shorebird
      - name: Shorebird Login
        run: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird login --ci-token ${{ secrets.SHOREBIRD_AUTH_TOKEN }}
          
      # 6Ô∏è‚É£ Check version change
      - name: Check version change
        id: version_check
        run: |
          VERSION_FILE="pubspec.yaml"
          CURRENT_VERSION=$(grep '^version:' $VERSION_FILE | awk '{print $2}')
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "Current version: $CURRENT_VERSION"
          
          # Get previous version from main branch
          git fetch origin main --depth=1 || echo "Unable to fetch main branch, assuming first build"
          
          if git show origin/main:pubspec.yaml 2>/dev/null | grep -q '^version:'; then
            OLD_VERSION=$(git show origin/main:pubspec.yaml | grep '^version:' | awk '{print $2}')
            echo "OLD_VERSION=$OLD_VERSION" >> $GITHUB_ENV
            echo "Old version: $OLD_VERSION"
            
            if [ "$CURRENT_VERSION" != "$OLD_VERSION" ]; then
              echo "VERSION_CHANGED=true" >> $GITHUB_ENV
              echo "‚úÖ Version changed from $OLD_VERSION to $CURRENT_VERSION"
            else
              echo "VERSION_CHANGED=false" >> $GITHUB_ENV
              echo "üîÑ No version change detected"
            fi
          else
            echo "VERSION_CHANGED=true" >> $GITHUB_ENV
            echo "üìù First build or unable to compare versions, building release"
          fi

      # 7Ô∏è‚É£ Build or patch using Shorebird
      - name: Build or Patch
        run: |
          export PATH="$HOME/.shorebird/bin:$PATH"
          
          if [ "$VERSION_CHANGED" = "true" ]; then
            echo "üöÄ Building new release (version: $CURRENT_VERSION)"
            # Build Android release
            shorebird release android --force --verbose || {
              echo "‚ùå Android release failed, trying with flutter build first"
              flutter build apk --release
              shorebird release android --force --verbose
            }
            
            # Build iOS release (if you have macOS runner)
            # shorebird release ios --force --verbose
          else
            echo "üß© Creating patch (no version change)"
            # Create Android patch
            shorebird patch android --verbose || {
              echo "‚ùå Android patch failed"
              exit 1
            }
            
            # Create iOS patch (if you have macOS runner)
            # shorebird patch ios --verbose
          fi

      # 8Ô∏è‚É£ Send to Telegram
      - name: Send APK to Telegram
        if: env.VERSION_CHANGED == 'true'
        run: |
          # Find the APK file
          APK_PATH=$(find build -name "*.apk" -type f | head -n 1)
          if [ -z "$APK_PATH" ]; then
            # Alternative path for Shorebird builds
            APK_PATH=$(find . -name "*.apk" -type f | grep -v "build/android" | head -n 1)
          fi
          
          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            echo "üì¶ Sending $APK_PATH to Telegram..."
            curl -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                 -F document=@"$APK_PATH" \
                 -F caption="üöÄ New App Release v$CURRENT_VERSION" \
                 https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument
          else
            echo "‚ùå APK file not found"
            find . -name "*.apk" -type f
          fi