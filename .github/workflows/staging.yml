name: Flutter CI/CD with Shorebird

on:
  push:
    branches:
      - staging

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_AUTH_TOKEN }}
  FLUTTER_VERSION: '3.29.3'

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: üìö Git Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Flutter
      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      # 3Ô∏è‚É£ Cache dependencies
      - name: üíæ Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('pubspec.lock') }}

      # 4Ô∏è‚É£ Install dependencies
      - name: üì¶ Install dependencies
        run: flutter pub get

      # 5Ô∏è‚É£ Setup Shorebird CLI
      - name: üê¶ Setup Shorebird
        uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true

      # 6Ô∏è‚É£ Setup Java (required for Android build)
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 7Ô∏è‚É£ Check if version changed compared to main
      - name: üîç Check version change
        id: version_check
        run: |
          VERSION_FILE="pubspec.yaml"

          CURRENT_VERSION=$(grep '^version:' $VERSION_FILE | awk '{print $2}')
          RELEASE_VERSION=$(grep '^release_version:' $VERSION_FILE | awk '{print $2}')

          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV

          echo "Current version: $CURRENT_VERSION"
          echo "Release version: $RELEASE_VERSION"

          git fetch origin main --depth=1 || echo "Unable to fetch main branch."
          if git show origin/main:pubspec.yaml 2>/dev/null | grep -q '^version:'; then
            OLD_VERSION=$(git show origin/main:pubspec.yaml | grep '^version:' | awk '{print $2}')
            echo "OLD_VERSION=$OLD_VERSION" >> $GITHUB_ENV
            if [ "$CURRENT_VERSION" != "$OLD_VERSION" ]; then
              echo "VERSION_CHANGED=true" >> $GITHUB_ENV
              echo "‚úÖ Version changed from $OLD_VERSION to $CURRENT_VERSION"
            else
              echo "VERSION_CHANGED=false" >> $GITHUB_ENV
              echo "üîÑ No version change detected"
            fi
          else
            echo "VERSION_CHANGED=true" >> $GITHUB_ENV
            echo "üìù First build or unable to compare versions"
          fi

      # 8Ô∏è‚É£ Run Shorebird Release or Patch (dynamic Flutter + release_version)
      - name: üöÄ Shorebird Release or Patch
        run: |
          echo "üìå Using Flutter version: $FLUTTER_VERSION"
          echo "üì¶ Using release version: $RELEASE_VERSION"

          if [ "$VERSION_CHANGED" = "true" ]; then
            echo "üÜï Building new release (.apk)..."
              shorebird release android \
              --no-confirm --verbose \
              --artifact=apk \
              --flutter-version="$FLUTTER_VERSION" \
              --no-tree-shake-icons \
          else
            echo "üß© Creating patch for release version $RELEASE_VERSION..."
              shorebird patch \
              --platforms=android \
              --release-version="$RELEASE_VERSION" \
              --no-confirm --verbose \
              --allow-native-diffs \
              --allow-asset-diffs
              
          fi

      # 9Ô∏è‚É£ Send APK to Telegram (only for new releases)
      - name: üì§ Send APK to Telegram
        if: env.VERSION_CHANGED == 'true'
        run: |
          set +e  # Don't exit on error

          echo "üîç Searching for APK file..."
          APK_PATH=$(find build/app/outputs/flutter-apk -type f -name "*release*.apk" | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "‚ö†Ô∏è app-release.apk not found in default path, searching entire repo..."
            APK_PATH=$(find . -type f -name "*release*.apk" | head -n 1)
          fi

          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            echo "‚úÖ Found APK: $APK_PATH"
            echo "üì¶ Sending to Telegram..."
            curl -s -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F document=@"$APK_PATH" \
                -F caption="üöÄ *New App Release v$CURRENT_VERSION*%0AüìÖ $(date '+%Y-%m-%d %H:%M')%0ABranch: staging%0ACommit: $GITHUB_SHA" \
                -F parse_mode=Markdown \
                https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument
          else
            echo "‚ùå APK file not found!"
            echo "Listing available build outputs for debugging:"
            find build/ -type f | head -n 50
          fi
